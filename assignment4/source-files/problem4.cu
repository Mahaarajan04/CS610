#include <cstdlib>
#include <cuda.h>
#include <iostream>
#include <numeric>
#include <sys/time.h>

#define THRESHOLD (std::numeric_limits<float>::epsilon())

using std::cerr;
using std::cout;
using std::endl;

#define cudaCheckError(ans)                                                    \
  { gpuAssert((ans), __FILE__, __LINE__); }
inline void gpuAssert(cudaError_t code, const char* file, int line,
                      bool abort = true) {
  if (code != cudaSuccess) {
    fprintf(stderr, "GPUassert: %s %s %d\n", cudaGetErrorString(code), file,
            line);
    if (abort)
      exit(code);
  }
}

const uint64_t N = (1 << 6);

// TODO: Edit the function definition as required
__global__ void kernel2D_basic() {}

__global__ void kernel2D_opt() {}

// TODO: Edit the function definition as required
__global__ void kernel3D_basic() {}

__global__ void kernel3D_opt() {}

__host__ void check_result(const float*** w_ref, const float*** w_opt) {
  double maxdiff = 0.0;
  int numdiffs = 0;

  for (uint64_t i = 0; i < N; i++) {
    for (uint64_t j = 0; j < N; j++) {
      for (uint64_t k = 0; k < N; k++) {
        double this_diff =
            w_ref[i + N * j + N * N * k] - w_opt[i + N * j + N * N * k];
        if (std::fabs(this_diff) > THRESHOLD) {
          numdiffs++;
          if (this_diff > maxdiff) {
            maxdiff = this_diff;
          }
        }
      }
    }
  }

  if (numdiffs > 0) {
    cout << numdiffs << " Diffs found over THRESHOLD " << THRESHOLD
         << "; Max Diff = " << maxdiff << endl;
  } else {
    cout << "No differences found between base and test versions\n";
  }
}

void print2D(const float* A) {
  for (int i = 0; i < N; ++i) {
    for (int j = 0; j < N; ++j) {
      cout << A[i * N + j] << "\t";
    }
    cout << "n";
  }
}

void print3D(const float* A) {
  for (int i = 0; i < N; ++i) {
    for (int j = 0; j < N; ++j) {
      for (int k = 0; k < N; ++k) {
        cout << A[i * N * N + j * N + k] << "\t";
      }
      cout << "n";
    }
    cout << "n";
  }
}

double rtclock() { // Seconds
  struct timezone Tzp;
  struct timeval Tp;
  int stat;
  stat = gettimeofday(&Tp, &Tzp);
  if (stat != 0) {
    cout << "Error return from gettimeofday: " << stat << "\n";
  }
  return (Tp.tv_sec + Tp.tv_usec * 1.0e-6);
}

int main() {
  // TODO: Invoke kernel2D_basic()
  // TODO: Adapt check_result()
  float kernel_time=0.0f;
  cout << "Kernel2D_basic time (ms): " << kernel_time << "\n";

  // TODO: Invoke kernel2D_opt()
  // TODO: Adapt check_result()
  cout << "kernel2D_opt time (ms): " << kernel_time << "\n";

  // TODO: Invoke kernel3D_basic()
  // TODO: Adapt check_result()
  cout << "Kernel3D_basic time (ms): " << kernel_time << "\n";

  // TODO: Invoke kernel3D_opt()
  // TODO: Adapt check_result()
  cout << "Kernel3D_opt time (ms): " << kernel_time << "\n";

  // TODO: Free memory

  return EXIT_SUCCESS;
}
